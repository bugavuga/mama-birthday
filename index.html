<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Мамочка, это твой день</title>
  <style>
    :root{
      --bg1:#ffe9dc;
      --bg2:#f8efe7;
      --bg3:#f9d9cf;
      --ink:#2a1f1c;
      --muted:#6c5b54;
      --accent:#f1576f;
      --accent2:#f7a35c;
      --card:#fff8f3;
      --shadow:0 20px 60px rgba(60,30,20,.18);
      --radius:24px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Trebuchet MS", "Segoe UI", Verdana, sans-serif;
      color:var(--ink);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(1200px 500px at 10% 10%, #fff8f0 0%, transparent 60%),
        radial-gradient(900px 500px at 90% 20%, #fde3d8 0%, transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2) 40%, var(--bg3));
      padding:24px;
      overflow-x:hidden;
    }
    body::before,
    body::after{
      content:"";
      position:fixed;
      z-index:0;
      width:340px;
      height:340px;
      border-radius:50%;
      opacity:.22;
      background:conic-gradient(from 20deg, #ffd3c2, #f7b0a6, #f9d3b7, #ffd3c2);
      animation:float 16s ease-in-out infinite;
    }
    body::before{ top:-120px; left:-80px; }
    body::after{ bottom:-140px; right:-60px; animation-delay:-6s; }
    @keyframes float{
      0%,100%{ transform:translateY(0px) rotate(0deg); }
      50%{ transform:translateY(18px) rotate(2deg); }
    }
    .sparkle-layer{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.55) 0 2px, transparent 3px),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,.4) 0 2px, transparent 4px);
      background-size:180px 180px, 220px 220px;
      animation:sparkleMove 18s linear infinite;
      opacity:.5;
    }
    @keyframes sparkleMove{
      from{ background-position:0 0, 40px 80px; }
      to{ background-position:180px 220px, 220px 120px; }
    }
    .heart-layer{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      overflow:hidden;
    }
    .heart{
      position:absolute;
      background:linear-gradient(135deg, #f1576f, #f7a35c);
      transform:rotate(45deg);
      opacity:0;
      animation:heartFloat 6s ease-in forwards;
      filter:drop-shadow(0 10px 18px rgba(241,87,111,.35));
    }
    .heart::before,
    .heart::after{
      content:"";
      position:absolute;
      width:100%;
      height:100%;
      border-radius:50%;
      background:inherit;
    }
    .heart::before{ top:-50%; left:0; }
    .heart::after{ left:-50%; top:0; }
    @keyframes heartFloat{
      0%{ transform:translate(0, 0) rotate(45deg) scale(.8); opacity:0; }
      15%{ opacity:.9; }
      100%{ transform:translate(var(--tx), var(--ty)) rotate(45deg) scale(1.1); opacity:0; }
    }
    .stage{
      position:relative;
      z-index:1;
      width:min(980px, 100%);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:26px;
      display:grid;
      grid-template-rows:auto 1fr auto;
      gap:18px;
    }
    .stage::before,
    .stage::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:inherit;
      pointer-events:none;
      opacity:.7;
      z-index:-1;
      background:
        radial-gradient(160px 120px at 10% 0%, rgba(247,163,92,.35), transparent 60%),
        radial-gradient(200px 160px at 90% 100%, rgba(241,87,111,.28), transparent 65%),
        linear-gradient(120deg, rgba(255,255,255,.6), rgba(255,255,255,0));
      filter:blur(10px);
    }
    .stage::after{
      inset:8px;
      opacity:.35;
      filter:blur(22px);
      background:
        radial-gradient(220px 140px at 80% 0%, rgba(255,212,190,.5), transparent 65%),
        radial-gradient(260px 160px at 0% 100%, rgba(241,87,111,.22), transparent 70%);
    }
    .stage{
      max-height:min(860px, 92vh);
    }
    .stage-reveal{
      animation:stageIn .65s ease;
    }
    @keyframes stageIn{
      from{ opacity:.6; transform:translateY(10px) scale(.985); }
      to{ opacity:1; transform:translateY(0) scale(1); }
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
    }
    .title{
      font-family:Georgia, "Times New Roman", serif;
      font-size:30px;
      margin:0;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:15px;
    }
    .badge{
      position:relative;
      font-size:12px;
      font-weight:700;
      letter-spacing:.08em;
      padding:10px 14px;
      border-radius:999px;
      color:#fff;
      background:linear-gradient(130deg, var(--accent), var(--accent2));
      text-transform:uppercase;
      white-space:nowrap;
      align-self:center;
      overflow:hidden;
    }
    .badge::after{
      content:"";
      position:absolute;
      inset:-6px;
      background:linear-gradient(120deg, transparent, rgba(255,255,255,.5), transparent);
      transform:translateX(-120%);
      animation:badgeShine 3.8s ease-in-out infinite;
    }
    @keyframes badgeShine{
      0%,70%{ transform:translateX(-120%); }
      100%{ transform:translateX(120%); }
    }
    .chat{
      background:#fff;
      border-radius:18px;
      padding:22px;
      min-height:320px;
      display:flex;
      flex-direction:column;
      gap:12px;
      box-shadow:inset 0 0 0 1px rgba(0,0,0,.05);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      scrollbar-color:#f3c1b5 transparent;
      scrollbar-width:thin;
    }
    .chat-wrap{
      position:relative;
    }
    .scroll-hint{
      position:absolute;
      left:50%;
      bottom:10px;
      transform:translateX(-50%);
      padding:6px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      color:#fff;
      background:linear-gradient(135deg, rgba(241,87,111,.9), rgba(247,163,92,.9));
      box-shadow:0 10px 20px rgba(241,87,111,.25);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
    }
    .scroll-hint.is-visible{
      opacity:1;
      animation:hintPulse 1.8s ease-in-out infinite;
    }
    @keyframes hintPulse{
      0%,100%{ transform:translateX(-50%) scale(1); }
      50%{ transform:translateX(-50%) scale(1.04); }
    }
    .bubble{
      max-width:min(560px, 92%);
      padding:12px 16px;
      border-radius:18px;
      line-height:1.5;
      opacity:0;
      transform:translateY(10px);
      animation:reveal .6s ease forwards;
    }
    .bubble.glow{
      box-shadow:0 12px 26px rgba(241,87,111,.18), 0 0 18px rgba(247,163,92,.22);
    }
    .bot{
      background:#f6ebe5;
      align-self:flex-start;
      border-bottom-left-radius:6px;
    }
    .me{
      background:linear-gradient(135deg, #fde1d5, #f8bba5);
      align-self:flex-end;
      border-bottom-right-radius:6px;
    }
    .typing{
      display:flex;
      gap:6px;
      align-items:center;
      background:#f6ebe5;
      width:86px;
      padding:10px 14px;
      border-radius:18px;
      border-bottom-left-radius:6px;
      opacity:.9;
    }
    .dot{
      width:6px;
      height:6px;
      border-radius:50%;
      background:#c58b7b;
      animation:blink 1.2s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay:.2s; }
    .dot:nth-child(3){ animation-delay:.4s; }
    @keyframes blink{
      0%,100%{ opacity:.2; transform:translateY(0); }
      50%{ opacity:1; transform:translateY(-2px); }
    }
    @keyframes reveal{
      to{ opacity:1; transform:translateY(0); }
    }
    .final-photo{
      margin-top:10px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
      width:100px;
      height:100px;
      animation:photoGlow 2.8s ease-in-out infinite;
      position:relative;
    }
    .final-photo img{
      display:block;
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .photo-modal{
      position:fixed;
      inset:0;
      z-index:5;
      display:none;
      align-items:center;
      justify-content:center;
      padding:24px;
      background:radial-gradient(600px 300px at 20% 20%, rgba(255,255,255,.5), transparent 60%),
        linear-gradient(160deg, rgba(42,31,28,.7), rgba(42,31,28,.45));
      backdrop-filter:blur(8px);
    }
    .photo-modal.is-open{
      display:flex;
      animation:fadeIn .4s ease;
    }
    @keyframes fadeIn{
      from{ opacity:0; }
      to{ opacity:1; }
    }
    .photo-frame{
      position:relative;
      max-width:min(640px, 92vw);
      max-height:80vh;
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.4);
      box-shadow:0 24px 60px rgba(0,0,0,.35);
      animation:popIn .45s ease;
      background:#111;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .photo-frame::before{
      content:"";
      position:absolute;
      inset:-18px;
      border-radius:28px;
      background:
        radial-gradient(200px 160px at 20% 20%, rgba(247,163,92,.5), transparent 65%),
        radial-gradient(240px 180px at 80% 80%, rgba(241,87,111,.45), transparent 70%);
      filter:blur(12px);
      opacity:.8;
      z-index:-1;
    }
    @keyframes popIn{
      from{ transform:scale(.96) translateY(8px); }
      to{ transform:scale(1) translateY(0); }
    }
    .photo-frame img{
      display:block;
      max-width:92vw;
      max-height:80vh;
      width:auto;
      height:auto;
      object-fit:contain;
    }
    .photo-bubble{
      padding:8px;
      max-width:100px;
    }
    .photo-bubble .final-photo{
      width:100%;
      margin-top:0;
    }
    .photo-tap{
      animation:tapZoom .25s ease;
    }
    @keyframes tapZoom{
      from{ transform:scale(1); }
      to{ transform:scale(1.04); }
    }
    .photo-close{
      position:absolute;
      top:10px;
      right:10px;
      border:0;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:700;
      color:#fff;
      background:rgba(0,0,0,.45);
      cursor:pointer;
    }
    @keyframes photoGlow{
      0%,100%{ transform:scale(1); box-shadow:0 10px 30px rgba(241,87,111,.22); }
      50%{ transform:scale(1.02); box-shadow:0 16px 36px rgba(247,163,92,.28); }
    }
    .confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:2;
    }
    .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .control-buttons{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .progress{
      font-size:14px;
      color:var(--muted);
    }
    .dots{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .dots span{
      width:8px;
      height:8px;
      border-radius:50%;
      background:#e6c1b6;
    }
    .dots .active{
      width:20px;
      border-radius:999px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
    }
    button{
      border:0;
      border-radius:999px;
      padding:12px 20px;
      font-size:15px;
      font-weight:700;
      color:white;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      cursor:pointer;
      box-shadow:0 12px 24px rgba(241,87,111,.35);
    }
    .ghost{
      color:var(--accent);
      background:transparent;
      box-shadow:inset 0 0 0 2px rgba(241,87,111,.35);
    }
    button:active{ transform:translateY(1px); }
    .parallax-shift{
      animation:parallaxShift .65s ease;
    }
    @keyframes parallaxShift{
      0%{ transform:translateY(0); }
      50%{ transform:translateY(-6px); }
      100%{ transform:translateY(0); }
    }
    @media (max-width:720px){
      .stage{ padding:20px; max-height:unset; }
      header{ flex-direction:column; align-items:flex-start; }
      .title{ font-size:26px; }
      .chat{ min-height:260px; max-height:62vh; }
      .photo-bubble{ max-width:100px; }
      .photo-frame{ max-width:92vw; max-height:74vh; }
      .photo-frame img{ max-width:86vw; max-height:70vh; }
    }
    @media (prefers-reduced-motion: reduce){
      *{
        animation-duration:.01ms !important;
        animation-iteration-count:1 !important;
        transition-duration:.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="sparkle-layer" aria-hidden="true"></div>
  <div class="heart-layer" id="heartLayer" aria-hidden="true"></div>
  <canvas class="confetti" id="confetti"></canvas>
  <section class="stage" aria-live="polite">
    <header>
      <div>
        <h1 class="title" id="slideTitle">Мамочка, это твой день!</h1>
        <p class="subtitle" id="slideSubtitle">Читай и жми "Далее" за сюрпризами ❤️</p>
      </div>
      <div class="badge">ЧАТ-БОТ</div>
    </header>

    <div class="chat-wrap">
      <div class="chat" id="chat"></div>
      <div class="scroll-hint" id="scrollHint">Листай вниз</div>
    </div>

    <div class="controls">
      <div>
        <div class="progress" id="progress">1 из 7</div>
        <div class="dots" id="dots"></div>
      </div>
      <div class="control-buttons">
        <button type="button" id="nextBtn">Далее ✨</button>
      </div>
    </div>
  </section>
  <div class="photo-modal" id="photoModal" aria-hidden="true">
    <div class="photo-frame" role="dialog" aria-modal="true" aria-label="Фото мамы">
      <button class="photo-close" type="button" id="photoClose">Закрыть</button>
      <img id="photoModalImg" src="" alt="">
    </div>
  </div>

  <script>
    const slides = [
      {
        title: "Мамочка, это твой день!",
        subtitle: "Хочу, чтобы ты почувствовала себя окутанной любовью словно теплым пледом.",
        buttonText: "Далее ✨",
        messages: [
          { from: "bot", text: "Читай и жми \"Далее\" за сюрпризами ❤️" }
        ]
      },
      {
        title: "Вопрос 1",
        subtitle: "",
        buttonText: "Далее ✨",
        messages: [
          { from: "bot", text: "Как зовут лучшую маму на свете?" },
          { from: "me", text: "Ирина. Самая обворожительная, самая помогающая и самая любимая ❤️ Ты — мой ангел-хранитель!" }
        ]
      },
      {
        title: "Вопрос 2",
        subtitle: "",
        buttonText: "Далее ✨",
        messages: [
          { from: "bot", text: "Что она любит больше всего?" },
          { from: "me", text: "Быть активной, помогать другим и заботиться о семье ❤️ Спасибо за твою поддержку, мама!" }
        ]
      },
      {
        title: "Вопрос 3",
        subtitle: "",
        buttonText: "Далее ✨",
        messages: [
          { from: "bot", text: "Какой её главный супер-талант?" },
          { from: "me", text: "Она уникальна, она хранительница и защитница семьи: исцеляет взглядом в самую душу, лечит энергией рук, предвидит судьбу интуитивно, видит людей насквозь. Примером Своей Жизни и стойкостью вдохновляет и меняет окружающих!" }
        ]
      },
      {
        title: "Вопрос 4",
        subtitle: "",
        buttonText: "Далее ✨",
        messages: [
          { from: "bot", text: "Что делает Ирину особенной?" },
          { from: "me", text: "Её смех, лучезарная улыбка, исцеляющая энергия, сила духа, смекалка, любознательность и бесконечная любовь к близким ❤️" }
        ]
      },
      {
        title: "Вопрос 5",
        subtitle: "",
        buttonText: "Финал",
        messages: [
          { from: "bot", text: "За что мы все любим Ирину?" },
          { from: "me", text: "За всё! За то, что ты есть! За уют дома, за веру в близких, за ответственность ✨ и за то, что ты — НАША СЕМЬЯ!" }
        ]
      },
      {
        title: "Финальное поздравление",
        subtitle: "",
        buttonText: "Сначала",
        messages: [
          { from: "bot", text: "Мамочка, С ДНЁМ РОЖДЕНИЯ! Ты — берегиня нашей семьи. Спасибо за каждый миг рядом, за твою улыбку и тепло." },
          { from: "me", text: "Любим тебя бесконечно! ❤️ И бесконечно гордимся." }
        ],
        image: {
          src: "photo.jpg",
          srcSmall: "photo_small.jpg",
          alt: "Фото мамы"
        }
      }
    ];

    const chat = document.getElementById("chat");
    const title = document.getElementById("slideTitle");
    const subtitle = document.getElementById("slideSubtitle");
    const progress = document.getElementById("progress");
    const dots = document.getElementById("dots");
    const nextBtn = document.getElementById("nextBtn");
    const scrollHint = document.getElementById("scrollHint");
    const stage = document.querySelector(".stage");
    const heartLayer = document.getElementById("heartLayer");
    const photoModal = document.getElementById("photoModal");
    const photoModalImg = document.getElementById("photoModalImg");
    const photoClose = document.getElementById("photoClose");
    const confettiCanvas = document.getElementById("confetti");
    const confettiCtx = confettiCanvas.getContext("2d");

    let index = 0;
    let timeouts = [];
    let confettiTimer = null;
    let confettiFrame = null;
    let confettiPieces = [];
    let heartTimer = null;
    let audioCtx = null;
    let audioEnabled = false;
    let melodyPlaying = false;
    function clearTimeouts(){
      timeouts.forEach((id) => clearTimeout(id));
      timeouts = [];
    }

    function renderDots(){
      dots.innerHTML = "";
      slides.forEach((_, i) => {
        const dot = document.createElement("span");
        if (i === index) dot.classList.add("active");
        dots.appendChild(dot);
      });
    }
    function updateScrollHint(){
      if (!scrollHint) return;
      const overflow = chat.scrollHeight - chat.clientHeight > 8;
      const atBottom = chat.scrollTop + chat.clientHeight >= chat.scrollHeight - 6;
      scrollHint.classList.toggle("is-visible", overflow && !atBottom);
    }

    function showTyping(delay){
      const typing = document.createElement("div");
      typing.className = "typing";
      typing.innerHTML = "<span class=\"dot\"></span><span class=\"dot\"></span><span class=\"dot\"></span>";
      chat.appendChild(typing);
      playTyping();
      timeouts.push(setTimeout(() => typing.remove(), delay));
    }

    function resizeConfetti(){
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    }

    function spawnConfetti(){
      const colors = ["#f1576f", "#f7a35c", "#f9c18c", "#f6ebe5", "#ffd7c2"];
      confettiPieces = Array.from({ length: 140 }, () => ({
        x: Math.random() * confettiCanvas.width,
        y: -20 - Math.random() * confettiCanvas.height,
        size: 6 + Math.random() * 6,
        speed: 1.2 + Math.random() * 2.4,
        drift: -1 + Math.random() * 2,
        color: colors[Math.floor(Math.random() * colors.length)],
        tilt: Math.random() * Math.PI
      }));
    }

    function drawStar(ctx, x, y, radius, innerRadius, points){
      let rotation = Math.PI / 2 * 3;
      let step = Math.PI / points;
      ctx.beginPath();
      ctx.moveTo(x, y - radius);
      for (let i = 0; i < points; i++) {
        ctx.lineTo(x + Math.cos(rotation) * radius, y + Math.sin(rotation) * radius);
        rotation += step;
        ctx.lineTo(x + Math.cos(rotation) * innerRadius, y + Math.sin(rotation) * innerRadius);
        rotation += step;
      }
      ctx.lineTo(x, y - radius);
      ctx.closePath();
      ctx.fill();
    }

    function drawConfetti(){
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      confettiPieces.forEach((p) => {
        p.y += p.speed;
        p.x += p.drift;
        p.tilt += 0.08;
        if (p.y > confettiCanvas.height + 20) p.y = -20;
        confettiCtx.save();
        confettiCtx.translate(p.x, p.y);
        confettiCtx.rotate(p.tilt);
        confettiCtx.fillStyle = p.color;
        drawStar(confettiCtx, 0, 0, p.size, p.size * 0.45, 5);
        confettiCtx.restore();
      });
      confettiFrame = requestAnimationFrame(drawConfetti);
    }

    function startConfetti(){
      stopConfetti();
      resizeConfetti();
      spawnConfetti();
      drawConfetti();
      confettiTimer = setTimeout(stopConfetti, 6500);
    }

    function stopConfetti(){
      if (confettiTimer) clearTimeout(confettiTimer);
      confettiTimer = null;
      if (confettiFrame) cancelAnimationFrame(confettiFrame);
      confettiFrame = null;
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    }
    function initAudio(){
      if (audioCtx) {
        if (audioCtx.state === "suspended") audioCtx.resume();
        audioEnabled = true;
        return;
      }
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return;
      audioCtx = new AudioContext();
      audioEnabled = true;
    }
    function playTone(freq, startTime, duration, type, gain){
      if (!audioCtx) return;
      const oscillator = audioCtx.createOscillator();
      const envelope = audioCtx.createGain();
      oscillator.type = type || "sine";
      oscillator.frequency.value = freq;
      envelope.gain.setValueAtTime(0.0001, startTime);
      envelope.gain.exponentialRampToValueAtTime(gain || 0.12, startTime + 0.02);
      envelope.gain.exponentialRampToValueAtTime(0.0001, startTime + duration);
      oscillator.connect(envelope);
      envelope.connect(audioCtx.destination);
      oscillator.start(startTime);
      oscillator.stop(startTime + duration + 0.05);
    }
    function playTyping(){
      if (!audioEnabled || !audioCtx) return;
      const now = audioCtx.currentTime;
      for (let i = 0; i < 4; i++) {
        playTone(1200 + Math.random() * 200, now + i * 0.05, 0.07, "square", 0.08);
      }
    }
    function playMessagePing(){
      if (!audioEnabled || !audioCtx) return;
      const now = audioCtx.currentTime;
      playTone(880, now, 0.12, "sine", 0.12);
      playTone(1320, now + 0.12, 0.18, "sine", 0.1);
    }
    function playHappyBirthday(){
      if (!audioEnabled || !audioCtx || melodyPlaying) return;
      const melody = [
        [392, 0.35], [392, 0.35], [440, 0.7], [392, 0.7], [523, 0.7], [494, 1.2],
        [392, 0.35], [392, 0.35], [440, 0.7], [392, 0.7], [587, 0.7], [523, 1.2],
        [392, 0.35], [392, 0.35], [784, 0.7], [659, 0.7], [523, 0.7], [494, 0.7], [440, 1.2],
        [698, 0.35], [698, 0.35], [659, 0.7], [523, 0.7], [587, 0.7], [523, 1.2]
      ];
      melodyPlaying = true;
      let start = audioCtx.currentTime + 0.1;
      melody.forEach(([freq, duration]) => {
        playTone(freq, start, duration, "triangle", 0.12);
        start += duration * 1.05;
      });
      setTimeout(() => {
        melodyPlaying = false;
      }, (start - audioCtx.currentTime) * 1000 + 120);
    }
    function spawnHeart(){
      if (!heartLayer || heartLayer.childElementCount > 20) return;
      const heart = document.createElement("span");
      heart.className = "heart";
      const size = 10 + Math.random() * 16;
      const duration = 4.2 + Math.random() * 2.2;
      const edge = Math.floor(Math.random() * 4);
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const offset = 24;
      let startX = 0;
      let startY = 0;
      let tx = 0;
      let ty = 0;
      if (edge === 0) {
        startX = Math.random() * vw;
        startY = -offset;
        tx = (Math.random() - 0.5) * 60;
        ty = 140 + Math.random() * 60;
      } else if (edge === 1) {
        startX = vw + offset;
        startY = Math.random() * vh;
        tx = -(140 + Math.random() * 60);
        ty = (Math.random() - 0.5) * 60;
      } else if (edge === 2) {
        startX = Math.random() * vw;
        startY = vh + offset;
        tx = (Math.random() - 0.5) * 60;
        ty = -(140 + Math.random() * 60);
      } else {
        startX = -offset;
        startY = Math.random() * vh;
        tx = 140 + Math.random() * 60;
        ty = (Math.random() - 0.5) * 60;
      }
      heart.style.width = `${size}px`;
      heart.style.height = `${size}px`;
      heart.style.left = `${startX}px`;
      heart.style.top = `${startY}px`;
      heart.style.setProperty("--tx", `${tx}px`);
      heart.style.setProperty("--ty", `${ty}px`);
      heart.style.animationDuration = `${duration}s`;
      heartLayer.appendChild(heart);
      setTimeout(() => heart.remove(), duration * 1000);
    }
    function startHearts(){
      if (heartTimer) return;
      spawnHeart();
      heartTimer = setInterval(spawnHeart, 800);
    }

    function renderSlide(){
      clearTimeouts();
      chat.innerHTML = "";
      title.textContent = slides[index].title;
      subtitle.textContent = slides[index].subtitle;
      progress.textContent = `${index + 1} из ${slides.length}`;
      renderDots();
      stage.classList.remove("stage-reveal");
      void stage.offsetWidth;
      stage.classList.add("stage-reveal");
      document.body.classList.remove("parallax-shift");
      void document.body.offsetWidth;
      document.body.classList.add("parallax-shift");

      let delay = 300;
      slides[index].messages.forEach((message, i) => {
        showTyping(delay);
        delay += 600;
        const bubble = document.createElement("div");
        bubble.className = `bubble ${message.from}`;
        bubble.textContent = message.text;
        timeouts.push(setTimeout(() => {
          chat.appendChild(bubble);
          bubble.classList.add("glow");
          setTimeout(() => bubble.classList.remove("glow"), 1200);
          if (message.from === "bot") playMessagePing();
          chat.scrollTop = chat.scrollHeight;
          updateScrollHint();
        }, delay));
        delay += 520 + i * 80;
      });

      if (slides[index].image) {
        timeouts.push(setTimeout(() => {
          const photoBubble = document.createElement("div");
          photoBubble.className = "bubble me photo-bubble";
          const photoWrap = document.createElement("div");
          photoWrap.className = "final-photo";
          const img = document.createElement("img");
          const isMobile = window.matchMedia("(max-width: 720px)").matches;
          img.src = isMobile && slides[index].image.srcSmall
            ? slides[index].image.srcSmall
            : slides[index].image.src;
          img.alt = slides[index].image.alt;
          photoWrap.appendChild(img);
          photoBubble.appendChild(photoWrap);
          chat.appendChild(photoBubble);
          img.addEventListener("load", () => {
            chat.scrollTop = chat.scrollHeight;
            updateScrollHint();
          });
          const openPhoto = () => {
            photoWrap.classList.add("photo-tap");
            setTimeout(() => photoWrap.classList.remove("photo-tap"), 260);
            const modalSrc = isMobile && slides[index].image.srcSmall
              ? slides[index].image.srcSmall
              : slides[index].image.src;
            photoModalImg.src = modalSrc;
            photoModalImg.alt = slides[index].image.alt;
            photoModal.classList.add("is-open");
            photoModal.setAttribute("aria-hidden", "false");
          };
          photoWrap.addEventListener("click", openPhoto);
          chat.scrollTop = chat.scrollHeight;
          updateScrollHint();
        }, delay + 300));
      }

      if (index === slides.length - 1) {
        startConfetti();
        playHappyBirthday();
      } else {
        stopConfetti();
      }

      nextBtn.textContent = slides[index].buttonText;
    }

    nextBtn.addEventListener("click", () => {
      initAudio();
      index = index === slides.length - 1 ? 0 : index + 1;
      renderSlide();
    });

    photoClose.addEventListener("click", () => {
      photoModal.classList.remove("is-open");
      photoModal.setAttribute("aria-hidden", "true");
    });
    photoModal.addEventListener("click", (event) => {
      if (event.target === photoModal) {
        photoModal.classList.remove("is-open");
        photoModal.setAttribute("aria-hidden", "true");
      }
    });

    window.addEventListener("resize", resizeConfetti);
    chat.addEventListener("scroll", updateScrollHint);

    startHearts();
    renderSlide();
  </script>
</body>
</html>
